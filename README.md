Multi-Stage WhatsApp Automation with Google Sheets Integration
This document describes a four-stage process for automating WhatsApp interactions using the venom-bot library and integrating data with Google Sheets.
Requirements:
Node.js and npm installed
venom-bot library (npm install venom-bot)
A Google Sheets account with the Spreadsheet API enabled (https://developers.google.com/sheets/api/guides/concepts)
A Google Service Account with the necessary permissions (https://m.youtube.com/watch?v=7qU_f__95Qc)
Stages:
Stage 1 (stage1.js): Prepares a JSON file containing contact information (name and phone number) for processing in later stages. 
Stage 2 (stage2.js): Reads contact information from a JSON file, validates phone numbers, checks for previous interactions, and prepares data for follow-up messages (if needed).
Stage 3 (stage3.js): Retrieves data from a Google Sheet, interacts with Stage 2's output, sends follow-up messages to valid contacts (if needed), and creates a report sheet in the Google Sheet documenting the process.
Utils (utils.js): Provides helper functions for parsing phone numbers, reading/writing JSON files, and interacting with Google Sheets using a Service Account.
 Overall Analysis:
These scripts demonstrate a multi-stage approach to WhatsApp bulk messaging automation. They handle contact information, validation, interaction history, and follow-up messages. While the provided code snippets don't show error handling or advanced message customization, they offer a basic framework for this functionality.

Understanding the Code:
Each stage is implemented in a separate JavaScript file (stage1.js, stage2.js, stage3.js).
The utils.js file contains helper functions used by other stages.
The code relies on the venom-bot library for WhatsApp automation and the google-spreadsheet library for interacting with Google Sheets.
Running the Script:
Configure Google Sheets:
Create a Google Sheet with columns for "name" and "number".
Enable the Spreadsheet API for your Google Sheet (https://developers.google.com/sheets/api/guides/concepts).
Create a Google Service Account and download the credentials as a JSON file (gsheetapi.json). Place this file in the same directory as your scripts. Configure the Service Account with the "Manage Spreadsheets'' permission.


Prepare Data:
Create a JSON file (./data/stage1.json) for Stage 1 containing an array of objects with "name" and "number" properties for each contact. (Note: Stage 1 code is not provided)
Modify Configuration:
In stage3.js, update the sheetId variable with the ID of your Google Sheet. You can find the sheet ID in the URL after "spreadsheets/d/".
In stage3.js, update the subSheetName variable with the name of the sheet containing contact information.
Run the Script:
Open a terminal in the project directory and run node stage3.js.
Expected Output:
Success messages indicating data retrieval, processing, and report sheet creation.
Error messages if issues occur during execution.
Additional Notes:
Consider increasing the protocolTimeout value in Puppeteer (if used within utils.js) to avoid timeouts during chat history loading, especially if you have a large number of contacts. Refer to the venom-bot documentation for Puppeteer configuration.
This code automates WhatsApp interactions, so ensure you comply with WhatsApp's Terms of Service and avoid spamming users.
Further Development:
Enhance error handling for robust operation.
Implement more sophisticated logic for follow-up messages based on interaction history.
Consider adding progress indicators or logging for better user experience.
Code Breakdown:
utils.js:
Provides helper functions:
parseWAChatId: Converts a phone number to WhatsApp chat ID format.
parseContactNumber: Extracts the phone number from a chat ID.
readJSONFileSync: Reads a JSON file synchronously.
writeJSONFileSync: Writes data to a JSON file synchronously. (Creates the "outputs" directory if it doesn't exist)
getSpreadSheetById: Uses a Service Account to access a Google Sheet by its ID.
Stage 1 (stage1.js) - Likely prepares a JSON file (./data/stage1.json) containing an array of objects with "name" and "number" properties for each contact.
Might send introductory messages to contacts using venom-bot.
Stage 2 (stage2.js):
Reads Contact Information: Reads contact data (name and phone number) from a JSON file (likely ./data/stage2.json). This file might be generated by Stage 1 (not provided).
Validates Phone Numbers: Checks if phone numbers are valid using client.checkNumberStatus from venom-bot.
Checks for Previous Interactions (Optional): (This functionality might not be implemented yet) It could potentially analyze chat history to see if a message has already been sent or if the user has replied.
Prepares Follow-up Messages (Optional): (This functionality might not be implemented yet) Based on interaction history, it could prepare messages for those who haven't responded.
Sends Follow-up Messages (if needed): If no prior interaction is detected and a follow-up message is prepared, it sends the message using client.sendText from venom-bot.
Creates Results Object: Creates a data structure for each contact, including name, number, validity status, and potentially interaction details.
Writes Results to JSON: Saves the results object to a new JSON file (./outputs/stage2-results.json) for Stage 3 to access.
Stage 3 (stage3.js):
Retrieves Data from Google Sheet: Uses utils.getSpreadSheetById to access a Google Sheet specified by its ID (sheetId) and sub-sheet name (subSheetName).
Processes Each Contact: Iterates through each row/contact in the sub-sheet.
Checks for Invalid Numbers: Skips rows with invalid phone numbers.
Fetches Chat History (Optional): It attempts to retrieve chat history using client.loadAndGetAllMessagesInChat from venom-bot. This might have an error handling issue as noted in the code.
Updates Contact Information: Based on chat history or previous results (from stage2-results.json), updates details like "repliedBack '' and "messages'â€™ (received messages from the user).
Sends Follow-up Messages (if needed): If no prior interaction is detected and the user hasn't replied, it sends a follow-up message using client.sendText from venom-bot.
Creates Report Sheet: Creates a new sheet in the Google Sheet with a title based on the sub-sheet name it processed.
Writes Report Data: Writes the processed contact data (including name, number, validity status, interaction details) to the newly created report sheet.

Benefits of Multi-Stage Approach:
Modular Design: Breaks down the process into smaller, more manageable stages, making it easier to understand, maintain, and debug.
Data Persistence: Saves intermediate results (e.g., Stage 2 output) to JSON files, allowing for error recovery and restarting stages independently.
Flexibility: Each stage can be modified or extended for specific needs without affecting the entire workflow.
Scalability: The approach can be easily adapted to handle larger datasets by adding more stages or parallel processing.


